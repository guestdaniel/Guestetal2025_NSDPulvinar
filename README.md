# Hierarchical processing of natural scenes in the human pulvinar
This is the code repository for Guest, Allen, Kay, and Arcaro (2025), "Hierarchical processing of natural scenes in the human pulvinar," which is currently in submission.
A preprint version of the paper is available on [BioRxiv](https://doi.org/10.1101/2025.03.20.644381).

## Data, stimuli, and other materials
This paper is an analysis of publically available data in the [Natural Scenes Dataset](naturalscenesdataset.org) (NSD).

To reproduce the analyses, you will need NSD to be available on your local machine.
It should be added as a folder entitled `nsd` in the `data` folder.
(See below for more details.)

In a [separate data repository](link to repo), we provide for convenience pre-computed data files containing our analyses that are used by the plotting code.
These data should be acquired stored in `data`, as a folder called `prepared`.

## Environment and dependencies
Code to produce the analyses and figures reported in the paper is written in a combination of MATLAB (for correlation analyses and surface plots, any recent version should do) and Python 3 (remaining figure/analysis code, tested on 3.12/3.13 but any recent version should do).

### MATLAB dependencies
- MATLAB toolboxes (Parallel Toolbox, Image Processing Toolbox)
- Kendrick Kay's [knkutils](https://github.com/cvnlab/knkutils/tree/master)

### Python dependencies
- matplotlib
- numpy
- nibabel
- skimage
- scipy

## Analysis and figure generation
Below, we list the steps required to reproduce the figures in the paper.

### Preprocessing
1. [Acquire the NSD data](naturalscenesdataset.org) and place it in `data/nsd` (or place a symbolic link to where you are storing the data, since it is quite large!).
2. You also need to acquire the NSD pRF data and place it in `data/nsdfaceprf`. 
3. Run `code/preproc/extract_data.py` to copy the relevant bits of the NSD data to the folders where they are expected to be by the plotting scripts. We only use a small subset of the data, so this should only occupy ~1 GB of space.
4. For several of these files, we then need to transform them from one space to another (e.g., 0.5mm subject-specific anatomical space to shared MNI space).
This is achieved by the `src/preproc/transform...` MATLAB scripts.
5. Compile various cortical ROIs needed in subsequent analysis steps with `src/preproc/compile_ROIs.m`

### Perform correlation analyses
Cortex-to-subcortex correlation analyses are implemented in MATLAB scripts `code/analysis/corr_cor_to_sub/*.m`.
1. `s02_average_cortical_data.m` computes average responses for each subject across pre-specified cortical ROIs and then stores them on disk.
2. `s03_compute_correlations.m` computes and saves values for the correlation between each of the average-ROI responses and responses in each voxel within the posterior thalamus ROI.

Subcortex-to-cortex correlation analyses are implemented in MATLAB and bash scripts `code/analysis/corr_sub_to_cor/*.m`.
1. `s01_compute_correlations.m` computes and then saves values for the correlation between each peak body or contrast voxel in each subject's subcortex with and every voxel on the subject's fsaverage cortical surface.
2. `s02_plot_surfaces.m` plots theses correlations on the fsaverage surface.
3. `s03_postprocess_images.sh` postprocesses these images to make them publication-ready (e.g., cropping white space, resizing, etc.)

Note that these scripts require a very large amount of memory (> 100 GB) as currently structured, and thus they are expected to be run on a high-performance computing cluster.
Unless you wish to reproduce these analyses, you can skip this step and use the prepared data in the `data/prepared` folder to proceed with figure generation (see below).

### Generate figures
With the necessary data available on disk and the analyses complete, you can generate the subcomponents of the figures as described below for each figure in order.
The script `code/generate_figures.py` will do most of this work for you!

#### Figure 1 (pRF methods)
This figure is hand-assembled from the stimulus image and feature files; no scripts are used.

#### Figure 2 (pRF rsqr and winner-take-all)
1. Figure 2A is generated by `fig_prf_wta_contextual_anatomy()` in `code/figs_gen/fig_prf_wta.py` (anatomy with ROI labels) and `fig_prf_wta_?` in `code/figs_gen/fig_prf_wta` (anatomy with variance explained overlay).
2. Figure 2B is generated by `fig_prf_wta_mip_maps()` in `code/figs_gen/fig_prf_wta.py`
3. Figure 2C is generated by `fig_prf_wta_maps()` in `code/figs_gen/fig_prf_wta.py`.

#### Figure 3 (Spatial coding of contrast and bodies)
1. Figure 3A is generated by `fig_prf_contrast_anatomy()` in code/figs_gen/fig_prf_contrast.py`
2. Figure 3B is generated by `fig_prf_contrast_maps()` in `code/figs_gen/fig_prf_contrast.py`.
3. Figure 3C is generated by `fig_prf_body_maps()` in `code/figs_gen/fig_prf_body.py`.
4. Figure 3D is generated by `fig_prf_contrast_rf_coverage()` in `code/figs_gen/fig_prf_contrast.py`.
5. Figure 3E is generated by `fig_prf_body_rf_coverage()` in `code/figs_gen/fig_prf_contrast.py`.

#### Figure 4 (correlation methods and same-trials correlation results)
1. Figure 4A is assembled in Inkscape.
2. Figure 4B is assembled in Inkscape, but uses one map output from `code/analysis/corr_sub_to_cor/s02_plot_surfaces.m` as an example.
3. Figure 4C uses the outputs of `code/analysis/corr_sub_to_cor/s02_plot_surfaces.m` and `code/analysis/corr_sub_to_cor/s03_postprocess_images.sh`.

#### Figure 5 (Different-trials correlation results)
1. Figure 5A (correlation/stimulus schematic) is ssembled in Inkscape.
2. Figure 5B and 5C are based on the outputs of `code/analysis/corr_sub_to_cor/s02_plot_surfaces.m` and `code/analysis/corr_cor_to_sub/s03_postprocess_images.sh`.

#### Figure 6 (Cortex-to-subcortex correlation methods and results)
1. Figure 6A is assembled in Inkscape.
2. Figure 6B is generated by `plot_fig_corr_cor_to_sub_group_consistency_maps()` in `code/figs_gen/fig_corr_cor_to_sub.py`.
3. Figure 6C is generated by `plot_fig_corr_cor_to_sub_ventral_stream_avg_group_contours()` in `code/figs_gen/fig_corr_cor_to_sub.py`.
